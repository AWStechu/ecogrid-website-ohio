from flask import Flask, render_template, request, jsonify, redirect, url_for, flash, session
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user
import pymysql
import bcrypt
import os

app = Flask(__name__)
app.secret_key = os.environ.get('SECRET_KEY', 'your-secret-key-change-in-production')

# Flask-Login setup
login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'login'

# Database configuration - Updated for new Aurora cluster
DB_HOST = os.environ.get('DB_HOST', 'ecogrid-aurora-cluster.cluster-xxxxxxxxx.us-east-1.rds.amazonaws.com')
DB_USER = os.environ.get('DB_USER', 'admin')
DB_PASSWORD = os.environ.get('DB_PASSWORD', 'EcoGrid2025!')
DB_NAME = os.environ.get('DB_NAME', 'ecogrid')

@app.route('/health')
def health_check():
    return jsonify({"status": "healthy"}), 200

class User(UserMixin):
    def __init__(self, id, username, email):
        self.id = id
        self.username = username
        self.email = email

@login_manager.user_loader
def load_user(user_id):
    connection = get_db_connection()
    cursor = connection.cursor()
    cursor.execute("SELECT id, username, email FROM users WHERE id = %s", (user_id,))
    user_data = cursor.fetchone()
    cursor.close()
    connection.close()
    if user_data:
        return User(user_data[0], user_data[1], user_data[2])
    return None

def get_db_connection():
    try:
        return pymysql.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
            charset='utf8mb4'
        )
    except Exception as e:
        print(f"Database connection error: {e}")
        return None

def init_database():
    """Initialize database with users table and test data"""
    try:
        connection = get_db_connection()
        cursor = connection.cursor()
        
        # Create users table
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS users (
                id INT AUTO_INCREMENT PRIMARY KEY,
                username VARCHAR(50) UNIQUE NOT NULL,
                email VARCHAR(100) UNIQUE NOT NULL,
                password VARCHAR(255) NOT NULL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        """)
        
        # Create customer inquiries table for Join the Community form
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS customer_inquiries (
                id INT AUTO_INCREMENT PRIMARY KEY,
                first_name VARCHAR(50) NOT NULL,
                last_name VARCHAR(50) NOT NULL,
                email VARCHAR(100) NOT NULL,
                phone VARCHAR(20) NOT NULL,
                address TEXT NOT NULL,
                current_provider VARCHAR(100),
                monthly_bill VARCHAR(50),
                estimated_savings DECIMAL(10,2),
                status VARCHAR(20) DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_email (email),
                INDEX idx_created_at (created_at)
            )
        """)
        
        # Test users data
        test_users = [
            ('admin', 'admin@ecogrid.com', 'password123'),
            ('john_doe', 'john@ecogrid.com', 'energy2025'),
            ('sarah_green', 'sarah@ecogrid.com', 'solar123'),
            ('mike_wind', 'mike@ecogrid.com', 'turbine456'),
            ('lisa_hydro', 'lisa@ecogrid.com', 'water789')
        ]
        
        # Insert test users
        for username, email, password in test_users:
            # Hash password
            hashed_password = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
            
            # Insert user (ignore if already exists)
            cursor.execute("""
                INSERT IGNORE INTO users (username, email, password) 
                VALUES (%s, %s, %s)
            """, (username, email, hashed_password))
        
        connection.commit()
        cursor.close()
        connection.close()
        print("Database initialized successfully!")
    except Exception as e:
        print(f"Database initialization error: {e}")

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/projects')
def projects():
    return render_template('projects.html')

@app.route('/join-community')
def join_community():
    return render_template('join-community.html')

@app.route('/volunteer')
def volunteer():
    return redirect(url_for('login'))

@app.route('/customer-login')
def customer_login():
    return render_template('volunteer.html')

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        
        connection = get_db_connection()
        if not connection:
            flash('Database connection error. Please try again later.')
            return render_template('volunteer.html')
            
        cursor = connection.cursor()
        cursor.execute("SELECT id, username, email, password FROM users WHERE username = %s", (username,))
        user_data = cursor.fetchone()
        cursor.close()
        connection.close()
        
        if user_data and bcrypt.checkpw(password.encode('utf-8'), user_data[3].encode('utf-8')):
            user = User(user_data[0], user_data[1], user_data[2])
            login_user(user)
            return redirect(url_for('dashboard'))
        else:
            flash('Invalid credentials')
    
    return render_template('volunteer.html')

@app.route('/dashboard')
@login_required
def dashboard():
    return render_template('dashboard.html')

@app.route('/logout')
@login_required
def logout():
    logout_user()
    return redirect(url_for('home'))

@app.route('/api/join-community', methods=['POST'])
def submit_join_community():
    try:
        data = request.json
        
        # Calculate potential savings based on monthly bill
        bill_ranges = {
            'under-50': 25,
            '50-100': 75,
            '100-150': 125,
            '150-200': 175,
            '200-300': 250,
            'over-300': 350
        }
        
        monthly_bill = bill_ranges.get(data.get('monthlyBill', ''), 100)
        # Assume 30% savings with EcoGrid
        annual_savings = int(monthly_bill * 12 * 0.3)
        
        # Store customer inquiry in database
        connection = get_db_connection()
        if connection:
            cursor = connection.cursor()
            cursor.execute("""
                INSERT INTO customer_inquiries 
                (first_name, last_name, email, phone, address, current_provider, monthly_bill, estimated_savings)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
            """, (
                data.get('firstName', ''),
                data.get('lastName', ''),
                data.get('email', ''),
                data.get('phone', ''),
                data.get('address', ''),
                data.get('currentProvider', ''),
                data.get('monthlyBill', ''),
                annual_savings
            ))
            connection.commit()
            cursor.close()
            connection.close()
            print(f"Customer inquiry stored: {data.get('firstName')} {data.get('lastName')} - Potential savings: ${annual_savings}/year")
        else:
            print(f"Database unavailable - Customer inquiry: {data.get('firstName')} {data.get('lastName')} - Potential savings: ${annual_savings}/year")
        
        return jsonify({
            'status': 'success', 
            'message': 'Eligibility confirmed!',
            'savings': annual_savings
        })
    except Exception as e:
        print(f"Error in join-community API: {e}")
        return jsonify({'status': 'error', 'message': 'Please try again later'}), 500

@app.route('/api/volunteer', methods=['POST'])
def submit_volunteer():
    try:
        data = request.json
        connection = get_db_connection()
        cursor = connection.cursor()
        
        cursor.execute("""
            INSERT INTO volunteers (name, email, phone, interests, availability)
            VALUES (%s, %s, %s, %s, %s)
        """, (
            data['name'],
            data['email'],
            data['phone'],
            data['interests'],
            data['availability']
        ))
        
        connection.commit()
        cursor.close()
        connection.close()
        
        return jsonify({'status': 'success', 'message': 'Thank you for volunteering!'})
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

# Initialize database when module is imported (with error handling)
try:
    init_database()
    print("Database initialized successfully")
except Exception as e:
    print(f"Database initialization error: {e}")
    print("Application will continue without database functionality")

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
